<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Economy Simulator: The Ruler's Choice</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #c0392b;
            --bg: #ecf0f1;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg);
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
        }

        .container {
            background: white;
            width: 100%;
            max-width: 700px;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        h1 { color: var(--primary); margin: 0 0 10px 0; font-weight: 800; }
        h2 { color: #7f8c8d; font-size: 1.1rem; margin-bottom: 25px; font-weight: 400; }

        /* Steps & Animation */
        .step { display: none; opacity: 0; transition: opacity 0.4s ease-in-out; }
        .step.active { display: block; opacity: 1; animation: slideUp 0.5s; }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Forms */
        input, button {
            width: 100%;
            padding: 14px;
            margin: 8px 0;
            border-radius: 10px;
            border: 2px solid #dfe6e9;
            font-family: 'Sarabun', sans-serif;
            box-sizing: border-box;
            font-size: 1rem;
        }
        input:focus { border-color: var(--accent); outline: none; }

        button {
            background-color: var(--accent);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        button:active { transform: translateY(0); }

        .btn-mode { background: white; color: var(--primary); border: 2px solid #bdc3c7; }
        .btn-mode:hover { border-color: var(--accent); background: #fdfdfd; }
        
        .btn-choice { text-align: left; margin-bottom: 10px; background: #fff; color: #333; border: 2px solid #eee; }
        .btn-choice:hover { border-color: var(--accent); background: #f4faff; }

        /* Cards */
        .system-card {
            border: 2px solid #eee;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            cursor: pointer;
            transition: 0.3s;
            text-align: left;
            position: relative;
            overflow: hidden;
        }
        .system-card:hover { border-color: var(--accent); transform: scale(1.02); }
        .system-card h3 { margin: 0; color: var(--primary); }
        .system-card p { font-size: 0.9rem; color: #666; margin-top: 5px; }
        .badge { 
            position: absolute; right: 10px; top: 10px; 
            background: #eee; padding: 3px 8px; border-radius: 10px; font-size: 0.7rem; 
        }

        /* Quest UI */
        .quest-box {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid var(--accent);
        }
        .progress-bar {
            height: 6px; background: #eee; border-radius: 3px; margin: 20px 0; overflow: hidden;
        }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.3s; }

        /* Result Graph */
        .bar-row { display: flex; align-items: center; margin: 8px 0; font-size: 0.85rem; }
        .bar-name { width: 100px; text-align: right; padding-right: 10px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .bar-track { flex-grow: 1; background: #eee; height: 24px; border-radius: 12px; overflow: hidden; }
        .bar-val { height: 100%; color: white; line-height: 24px; padding-left: 10px; font-size: 0.75rem; transition: width 1s ease-out; width: 0; }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        .stat-box { background: #f8f9fa; padding: 10px; border-radius: 10px; }
        .stat-val { font-size: 1.4rem; font-weight: 800; color: var(--primary); }
        .stat-label { font-size: 0.8rem; color: #7f8c8d; }

    </style>
</head>
<body>

<div class="container" id="game-container">
    
    <div id="step-mode" class="step active">
        <h1>üèõÔ∏è Economy Simulator</h1>
        <h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
        <button class="btn-mode" onclick="setMode('single')">üë§ ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (Solo Commander)</button>
        <button class="btn-mode" onclick="setMode('group')">üë• ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏° (Classroom Party)</button>
    </div>

    <div id="step-setup" class="step">
        <h1 id="setup-title">‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h1>
        <input type="text" id="group-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®/‡πÄ‡∏Å‡∏≤‡∏∞...">
        
        <div id="group-inputs" style="display:none;">
            <p style="text-align:left; font-size:0.9rem;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°:</p>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="new-member" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô..." onkeypress="handleEnter(event)">
                <button onclick="addMember()" style="width: 20%;">+</button>
            </div>
            <div id="member-list" style="text-align:left; max-height:150px; overflow-y:auto; margin-top:10px;"></div>
        </div>

        <div id="single-inputs" style="display:none;">
            <p style="text-align:left; font-size:0.9rem;">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ô‡∏≥ (‡∏ï‡∏±‡∏ß‡∏Ñ‡∏∏‡∏ì):</p>
            <input type="text" id="leader-name" placeholder="‡∏ó‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏ô‡∏≥...">
        </div>

        <div style="margin-top: 20px;">
            <button onclick="goToSystem()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏≠‡∏ö‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à</button>
            <button onclick="backToMode()" style="background:#95a5a6;">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        </div>
    </div>

    <div id="step-system" class="step">
        <h1>üìú ‡∏ò‡∏£‡∏£‡∏°‡∏ô‡∏π‡∏ç‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</h1>
        <h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡∏≤‡∏∞‡∏ô‡∏µ‡πâ</h2>
        
        <div class="system-card" onclick="startQuests('market')">
            <span class="badge">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á</span>
            <h3>üèôÔ∏è ‡∏ó‡∏∏‡∏ô‡∏ô‡∏¥‡∏¢‡∏°‡πÄ‡∏™‡∏£‡∏µ (Free Market)</h3>
            <p>‡πÄ‡∏ô‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï ‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡∏ç‡πà ‡∏£‡∏±‡∏ê‡πÅ‡∏ó‡∏£‡∏Å‡πÅ‡∏ã‡∏á‡∏ô‡πâ‡∏≠‡∏¢</p>
        </div>
        <div class="system-card" onclick="startQuests('command')">
            <span class="badge">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡∏™‡∏π‡∏á</span>
            <h3>üö© ‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏ô‡∏¥‡∏¢‡∏°‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô (Command)</h3>
            <p>‡∏£‡∏±‡∏ê‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏ó‡∏µ‡∏¢‡∏°‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</p>
        </div>
        <div class="system-card" onclick="startQuests('mixed')">
            <span class="badge">‡∏™‡∏°‡∏î‡∏∏‡∏•</span>
            <h3>‚öñÔ∏è ‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡∏ú‡∏™‡∏° (Mixed)</h3>
            <p>‡∏Å‡∏•‡πÑ‡∏Å‡∏ï‡∏•‡∏≤‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏£‡∏±‡∏ê‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£</p>
        </div>
    </div>

    <div id="step-quest" class="step">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <span style="font-weight:bold; color:var(--accent);">Decision Time</span>
            <span id="quest-count" style="color:#999;">1/5</span>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="quest-progress"></div></div>

        <div class="quest-box">
            <h2 id="quest-title" style="color:#333; margin-bottom:10px;">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤</h2>
            <p id="quest-desc" style="font-size:1.1rem; line-height:1.6;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå...</p>
        </div>

        <div id="quest-options">
            </div>
    </div>

    <div id="step-result" class="step">
        <h1 style="font-size:1.5rem;">üìä ‡∏ö‡∏ó‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏≤‡∏ï‡∏¥</h1>
        <h2 id="res-island-name" style="margin-bottom:10px; color:var(--accent); font-weight:bold;"></h2>
        <p id="res-system-sub" style="font-size:0.9rem; color:#777;"></p>

        <div class="stat-grid">
            <div class="stat-box">
                <div class="stat-val" id="score-gdp">0</div>
                <div class="stat-label">GDP (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏á‡∏Ñ‡∏±‡πà‡∏á)</div>
            </div>
            <div class="stat-box">
                <div class="stat-val" id="score-gini">0</div>
                <div class="stat-label">Gini (‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏•‡∏∑‡πà‡∏≠‡∏°‡∏•‡πâ‡∏≥)</div>
            </div>
            <div class="stat-box">
                <div class="stat-val" id="score-happy">0</div>
                <div class="stat-label">Happiness (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç)</div>
            </div>
        </div>

        <div id="analysis-box" style="background:#fff3cd; color:#856404; padding:15px; margin:20px 0; border-radius:10px; font-size:0.95rem;">
            </div>

        <div id="chart-container" style="text-align:left; margin-bottom:20px;">
            </div>

        <button onclick="downloadReport()" style="background-color:var(--primary);">üì∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏á‡∏≤‡∏ô (PNG)</button>
        <button onclick="location.reload()" style="background-color:#95a5a6; margin-top:5px;">üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà</button>
    </div>

</div>

<script>
    // --- Game State ---
    let mode = 'single';
    let members = [];
    let groupName = "";
    let selectedSystem = "";
    
    // Stats Multipliers (Base = 100%)
    let stats = {
        wealth: 100,
        inequality: 50, // 0 = Perfect Equality, 100 = Extreme Inequality
        happiness: 50
    };

    let currentQuestIndex = 0;

    // --- Data: Quests ---
    const quests = [
        {
            title: "‡∏ß‡∏¥‡∏Å‡∏§‡∏ï‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥",
            desc: "‡∏™‡∏´‡∏†‡∏≤‡∏û‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏£‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 2 ‡πÄ‡∏ó‡πà‡∏≤ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏£‡∏≠‡∏á‡∏ä‡∏µ‡∏û‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô ‡∏ô‡∏≤‡∏¢‡∏à‡πâ‡∏≤‡∏á‡∏Ç‡∏π‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏¢‡πâ‡∏≤‡∏¢‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏ó‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?",
            choices: [
                { txt: "‡∏¢‡∏≠‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏≤‡∏Å‡∏ó‡πâ‡∏≠‡∏á)", eff: { w: -10, i: -20, h: +20 } },
                { txt: "‡∏ï‡∏£‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡πÄ‡∏î‡∏¥‡∏° (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏î‡∏π‡∏î‡∏ô‡∏±‡∏Å‡∏•‡∏á‡∏ó‡∏∏‡∏ô)", eff: { w: +20, i: +15, h: -15 } },
                { txt: "‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÅ‡∏ö‡∏ö‡∏û‡∏ö‡∏Å‡∏±‡∏ô‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ó‡∏≤‡∏á", eff: { w: +5, i: -5, h: +5 } }
            ]
        },
        {
            title: "‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏£‡∏î‡∏Å",
            desc: "‡∏£‡∏±‡∏ê‡∏ñ‡∏±‡∏á‡πÅ‡∏ï‡∏Å! ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö '‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏£‡∏î‡∏Å' ‡πÉ‡∏ô‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡∏π‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡∏°‡∏≤‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•",
            choices: [
                { txt: "‡πÄ‡∏Å‡πá‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏´‡∏ô‡∏±‡∏Å‡∏Ñ‡∏ô‡∏£‡∏ß‡∏¢ (Robin Hood)", eff: { w: -5, i: -25, h: +10 } },
                { txt: "‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏ô‡πâ‡∏≠‡∏¢‡∏°‡∏≤‡∏Å (‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°)", eff: { w: +15, i: +20, h: -5 } }
            ]
        },
        {
            title: "‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ AI ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà",
            desc: "‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏ï‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å",
            choices: [
                { txt: "‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡πÑ‡∏Å‡∏ï‡∏•‡∏≤‡∏î (‡πÉ‡∏Ñ‡∏£‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Å‡πá‡πÅ‡∏û‡πâ)", eff: { w: +30, i: +30, h: -20 } },
                { txt: "‡πÄ‡∏Å‡πá‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå ‡∏°‡∏≤‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏ä‡∏î‡πÄ‡∏ä‡∏¢", eff: { w: -10, i: -15, h: +15 } }
            ]
        },
        {
            title: "‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡∏Å‡∏Ç‡∏≤‡∏î‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤",
            desc: "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏¢‡∏±‡∏Å‡∏©‡πå‡πÉ‡∏´‡∏ç‡πà‡∏£‡∏≤‡∏¢‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Å‡∏¥‡∏ô‡∏£‡∏ß‡∏ö‡∏ï‡∏•‡∏≤‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏∏‡∏õ‡πÇ‡∏†‡∏Ñ‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ‡∏à‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á",
            choices: [
                { txt: "‡∏≠‡∏≠‡∏Å‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏•‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡∏Å‡∏Ç‡∏≤‡∏î (Break them up)", eff: { w: -5, i: -10, h: +10 } },
                { txt: "‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ä‡∏°‡πÄ‡∏õ‡∏µ‡πâ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏ä‡∏≤‡∏ï‡∏¥", eff: { w: +25, i: +20, h: -10 } }
            ]
        },
        {
            title: "‡∏†‡∏±‡∏¢‡∏û‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ó‡∏≤‡∏á‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥",
            desc: "‡∏û‡∏≤‡∏¢‡∏∏‡∏ñ‡∏•‡πà‡∏°‡πÄ‡∏Å‡∏≤‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏´‡∏ô‡∏±‡∏Å! ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏°‡∏µ‡∏à‡∏≥‡∏Å‡∏±‡∏î ‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏Ñ‡∏£‡∏Å‡πà‡∏≠‡∏ô?",
            choices: [
                { txt: "‡∏≠‡∏∏‡πâ‡∏°‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡πÉ‡∏´‡∏ç‡πà (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏®‡∏Å.‡πÄ‡∏î‡∏¥‡∏ô‡∏ï‡πà‡∏≠)", eff: { w: +10, i: +25, h: -20 } },
                { txt: "‡πÅ‡∏à‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏¢‡∏µ‡∏¢‡∏ß‡∏¢‡∏≤‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô", eff: { w: -20, i: -20, h: +30 } }
            ]
        }
    ];

    // --- UI Navigation Functions ---

    function setMode(selectedMode) {
        mode = selectedMode;
        document.getElementById('step-mode').classList.remove('active');
        document.getElementById('step-setup').classList.add('active');

        if (mode === 'single') {
            document.getElementById('single-inputs').style.display = 'block';
        } else {
            document.getElementById('group-inputs').style.display = 'block';
        }
    }

    function backToMode() {
        document.getElementById('step-setup').classList.remove('active');
        document.getElementById('step-mode').classList.add('active');
        document.getElementById('single-inputs').style.display = 'none';
        document.getElementById('group-inputs').style.display = 'none';
        members = [];
        document.getElementById('member-list').innerHTML = '';
    }

    function handleEnter(e) { if(e.key === 'Enter') addMember(); }

    function addMember() {
        const val = document.getElementById('new-member').value.trim();
        if(val) {
            members.push(val);
            updateMemberList();
            document.getElementById('new-member').value = '';
        }
    }

    function updateMemberList() {
        document.getElementById('member-list').innerHTML = members.map((m,i) => 
            `<div style="background:#eee; padding:5px 10px; margin:2px 0; border-radius:5px; display:flex; justify-content:space-between;">
                <span>${i+1}. ${m}</span>
                <span style="color:red; cursor:pointer;" onclick="members.splice(${i},1); updateMemberList()">√ó</span>
            </div>`
        ).join('');
    }

    function goToSystem() {
        groupName = document.getElementById('group-name').value;
        if (!groupName) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏≤‡∏∞‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö"); return; }

        if (mode === 'group' && members.length < 2) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏Ñ‡∏ô"); return;
        }
        if (mode === 'single') {
            const leader = document.getElementById('leader-name').value || "‡∏ó‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏ô‡∏≥";
            members = [leader, "‡∏ô‡∏≤‡∏¢‡∏ó‡∏∏‡∏ô A", "‡∏ä‡∏≤‡∏ß‡∏ô‡∏≤ B", "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô C", "‡∏Ñ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏á‡∏≤‡∏ô D"];
        }

        document.getElementById('step-setup').classList.remove('active');
        document.getElementById('step-system').classList.add('active');
    }

    function startQuests(system) {
        selectedSystem = system;
        
        // Base Stats Setup
        if(system === 'market') { stats.wealth = 150; stats.inequality = 70; stats.happiness = 50; }
        else if(system === 'command') { stats.wealth = 80; stats.inequality = 10; stats.happiness = 60; }
        else { stats.wealth = 110; stats.inequality = 40; stats.happiness = 55; }

        document.getElementById('step-system').classList.remove('active');
        document.getElementById('step-quest').classList.add('active');
        renderQuest();
    }

    // --- Quest Engine ---

    function renderQuest() {
        if(currentQuestIndex >= quests.length) {
            finishGame();
            return;
        }

        const q = quests[currentQuestIndex];
        document.getElementById('quest-count').innerText = `${currentQuestIndex + 1}/${quests.length}`;
        document.getElementById('quest-progress').style.width = `${((currentQuestIndex)/quests.length)*100}%`;
        
        document.getElementById('quest-title').innerText = q.title;
        document.getElementById('quest-desc').innerText = q.desc;

        const btnContainer = document.getElementById('quest-options');
        btnContainer.innerHTML = '';

        q.choices.forEach(c => {
            const btn = document.createElement('button');
            btn.className = 'btn-choice';
            btn.innerHTML = `üëâ ${c.txt}`;
            btn.onclick = () => selectChoice(c.eff);
            btnContainer.appendChild(btn);
        });
    }

    function selectChoice(effect) {
        // Apply effects
        stats.wealth += effect.w;
        stats.inequality += effect.i;
        stats.happiness += effect.h;

        // Clamp values
        if(stats.inequality < 0) stats.inequality = 0;
        if(stats.inequality > 100) stats.inequality = 100;
        if(stats.happiness < 0) stats.happiness = 0;
        if(stats.happiness > 100) stats.happiness = 100;

        currentQuestIndex++;
        renderQuest();
    }

    // --- Final Calculation ---

    function finishGame() {
        document.getElementById('step-quest').classList.remove('active');
        document.getElementById('step-result').classList.add('active');

        // Render Stats
        document.getElementById('res-island-name').innerText = groupName;
        document.getElementById('res-system-sub').innerText = `‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à: ${selectedSystem.toUpperCase()}`;
        document.getElementById('score-gdp').innerText = stats.wealth;
        document.getElementById('score-gini').innerText = stats.inequality + "%";
        document.getElementById('score-happy').innerText = stats.happiness;

        // Analysis
        let analysis = "";
        if (stats.wealth > 140 && stats.inequality > 60) analysis = "üí∞ ‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏°‡∏±‡πà‡∏á‡∏Ñ‡∏±‡πà‡∏á‡∏°‡∏´‡∏≤‡∏®‡∏≤‡∏• ‡πÅ‡∏ï‡πà‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏£‡∏∞‡∏à‡∏∏‡∏Å‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (Oligarchy)";
        else if (stats.wealth < 90 && stats.inequality < 20) analysis = "ü§ù ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏ó‡∏µ‡∏¢‡∏°‡∏Å‡∏±‡∏ô ‡πÅ‡∏ï‡πà‡∏û‡∏≤‡∏Å‡∏±‡∏ô‡∏à‡∏ô (Shared Poverty) ‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡πÑ‡∏°‡πà‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï";
        else if (stats.happiness > 75) analysis = "üòä ‡∏£‡∏±‡∏ê‡πÉ‡∏ô‡∏ù‡∏±‡∏ô! ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç ‡πÅ‡∏°‡πâ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Å‡πá‡∏ï‡∏≤‡∏°";
        else if (stats.happiness < 30) analysis = "üî• ‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏•‡∏≤‡∏à‡∏•! ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÇ‡∏Å‡∏£‡∏ò‡πÅ‡∏Ñ‡πâ‡∏ô ‡∏£‡∏±‡∏ê‡∏ö‡∏≤‡∏•‡∏™‡∏±‡πà‡∏ô‡∏Ñ‡∏•‡∏≠‡∏ô";
        else analysis = "‚öñÔ∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡∏°‡∏î‡∏∏‡∏• ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢‡∏£‡∏≠‡∏≠‡∏¢‡∏π‡πà";
        document.getElementById('analysis-box').innerHTML = `<strong>‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:</strong> ${analysis}`;

        // Generate Distribution Graph
        renderGraph();
    }

    function renderGraph() {
        // Create individual wealth based on inequality stat
        // Higher inequality = steeper curve
        let totalWealth = stats.wealth * members.length * 10; // scale up
        let distribution = [];
        
        // Distribution algorithm based on Gini (simplified)
        // If ineq is high, power factor is high
        let power = 1 + (stats.inequality / 20); 

        // Random factors but sorted
        let randoms = members.map(() => Math.random()).sort((a,b) => a - b);
        
        if(selectedSystem === 'command') {
            // Command system flattens randoms
            randoms = randoms.map(r => 0.4 + (r * 0.2)); 
        }

        let shares = randoms.map(r => Math.pow(r, power));
        let sumShares = shares.reduce((a,b) => a+b, 0);
        
        let money = shares.map(s => Math.floor((s / sumShares) * totalWealth));
        
        // Sort money desc
        money.sort((a,b) => b-a);

        // Map back to members (Random shuffle names to make it fun)
        let shuffledMembers = [...members]; 
        // If single player, keep leader as one of them, but position depends on system? 
        // Let's just randomize who gets what for fun, unless it's Market (leader might be rich/poor)
        
        let chartHTML = "";
        let maxVal = money[0];
        
        // Color logic
        let barColor = selectedSystem === 'market' ? '#27ae60' : (selectedSystem === 'command' ? '#c0392b' : '#f39c12');

        for(let i=0; i<members.length; i++) {
            let width = (money[i] / maxVal) * 100;
            chartHTML += `
            <div class="bar-row">
                <div class="bar-name">${shuffledMembers[i]}</div>
                <div class="bar-track">
                    <div class="bar-val" style="width: ${width}%; background:${barColor};">${money[i].toLocaleString()}</div>
                </div>
            </div>`;
        }
        document.getElementById('chart-container').innerHTML = chartHTML;

        // Trigger animation
        setTimeout(() => {
            document.querySelectorAll('.bar-val').forEach(el => el.style.width = el.getAttribute('style').split(':')[1]);
        }, 100);
    }

    function downloadReport() {
        const element = document.getElementById("game-container");
        // Hide buttons for screenshot
        const buttons = element.querySelectorAll("button");
        buttons.forEach(b => b.style.display = 'none');
        
        html2canvas(element).then(canvas => {
            const link = document.createElement("a");
            link.download = `Report-${groupName}.png`;
            link.href = canvas.toDataURL();
            link.click();
            
            // Show buttons again
            buttons.forEach(b => b.style.display = 'inline-block');
        });
    }

</script>

</body>
</html>
